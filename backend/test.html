<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Test</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui, sans-serif; background: #0f0f0f; color: #e0e0e0; display: flex; height: 100vh; }

/* ── Layout ── */
#sidebar { width: 340px; border-right: 1px solid #2a2a2a; display: flex; flex-direction: column; overflow-y: auto; padding: 16px; gap: 16px; }
#main { flex: 1; display: flex; flex-direction: column; }
#chat-log { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
#input-bar { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid #2a2a2a; }
#input-bar input { flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; font-size: 14px; }
#input-bar button { padding: 10px 20px; border-radius: 8px; border: none; background: #3b82f6; color: #fff; font-weight: 600; cursor: pointer; }
#input-bar button:disabled { opacity: .4; cursor: default; }

/* ── Phase indicator ── */
#phase-bar { padding: 10px 16px; background: #1a1a1a; border-bottom: 1px solid #2a2a2a; font-size: 13px; color: #888; display: flex; align-items: center; gap: 12px; }
#phase-bar .dot { width: 8px; height: 8px; border-radius: 50%; }
.dot-tree { background: #3b82f6; }
.dot-form { background: #f59e0b; }
.dot-done { background: #22c55e; }

/* ── Chat bubbles ── */
.msg { padding: 10px 14px; border-radius: 10px; max-width: 80%; white-space: pre-wrap; font-size: 14px; line-height: 1.5; }
.msg-user { background: #3b82f6; align-self: flex-end; }
.msg-assistant { background: #1e1e1e; border: 1px solid #2a2a2a; align-self: flex-start; }
.msg-error { background: #7f1d1d; align-self: flex-start; }
.msg-system { background: transparent; color: #666; font-size: 12px; align-self: center; font-style: italic; }

/* ── Trees ── */
.tree-section h3 { font-size: 13px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }
.tree-node { display: flex; align-items: center; gap: 6px; padding: 4px 0; cursor: pointer; user-select: none; font-size: 14px; }
.tree-node:hover { color: #fff; }
.tree-children { margin-left: 20px; }
.node-check { width: 16px; height: 16px; border-radius: 4px; border: 2px solid #555; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; }
.node-check.selected { background: #3b82f6; border-color: #3b82f6; }

/* ── Form ── */
#form-section { display: none; }
#form-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
.form-field { margin-bottom: 10px; }
.form-field label { display: block; font-size: 12px; color: #888; margin-bottom: 3px; }
.form-field input { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; font-size: 13px; }

/* ── Lists / Cart ── */
#list-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
#list-items { font-size: 12px; color: #bdbdbd; white-space: pre-wrap; }

#sponsor-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
.sponsor-item { padding: 8px 10px; border: 1px solid #2a2a2a; border-radius: 8px; margin-bottom: 8px; background: #151515; }
.sponsor-item.pending { border-left: 4px solid #f59e0b; }
.sponsor-item.approved { border-left: 4px solid #22c55e; }
.sponsor-item.rejected { border-left: 4px solid #ef4444; }
.sponsor-item .name { font-size: 13px; color: #e0e0e0; margin-bottom: 4px; }
.sponsor-item .meta { font-size: 12px; color: #999; white-space: pre-wrap; }

#cart-section { display: none; }
#cart-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
.cart-item { padding: 8px 10px; border: 1px solid #2a2a2a; border-radius: 8px; margin-bottom: 8px; background: #151515; }
.cart-item .name { font-size: 13px; color: #e0e0e0; margin-bottom: 4px; }
.cart-item .meta { font-size: 12px; color: #999; }
.cart-total { margin-top: 8px; font-size: 13px; color: #cbd5f5; }


/* ── Sidebar controls ── */

/* ── Buttons ── */
.btn-action { width: 100%; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; }
#btn-submit-tree { background: #f59e0b; color: #000; display: none; }
#btn-submit-form { background: #22c55e; color: #000; display: none; }
.btn-action:hover { filter: brightness(1.1); }
</style>
</head>
<body>

<div id="sidebar">
  <div class="tree-section">
    <h3>People Tree</h3>
    <div id="people-tree"><span style="color:#555">No tree yet</span></div>
  </div>
  <div class="tree-section">
    <h3>Place Tree</h3>
    <div id="place-tree"><span style="color:#555">No tree yet</span></div>
  </div>
  <button id="btn-submit-tree" class="btn-action" onclick="submitTree()">Submit Trees →</button>

  <div id="form-section">
    <h3>Form</h3>
    <div id="form-fields"></div>
    <button id="btn-submit-form" class="btn-action" onclick="submitForm()">Submit Form ✓</button>
  </div>

  <div id="list-section">
    <h3>Shopping List</h3>
    <div id="list-items"><span style="color:#555">No list yet</span></div>
  </div>

  <div id="sponsor-section">
    <h3>Retailer Sponsorship</h3>
    <div id="sponsor-items"><span style="color:#555">No sponsor calls yet</span></div>
  </div>

  <div id="cart-section">
    <h3>Cart</h3>
    <div id="cart-items"><span style="color:#555">No cart yet</span></div>
    <div id="cart-total" class="cart-total"></div>
  </div>

</div>

<div id="main">
  <div id="phase-bar">
    <div class="dot dot-tree"></div>
    <span id="phase-text">Phase 1 — Chat with TreeAgent</span>
  </div>
  <div id="chat-log"></div>
  <div id="input-bar">
    <input id="msg-input" placeholder="Describe your event..." onkeydown="if(event.key==='Enter')sendMsg()">
    <button id="btn-send" onclick="sendMsg()">Send</button>
  </div>
</div>

<script>
const API = 'http://localhost:8000';
const SESSION = crypto.randomUUID().slice(0, 8);

let currentPeopleTree = null;
let currentPlaceTree = null;
let phase = 'tree'; // tree | form | done
let sending = false;

const $ = id => document.getElementById(id);
const log = $('chat-log');

// ── Chat helpers ──────────────────────────────────────────────

function addBubble(cls, text) {
  const d = document.createElement('div');
  d.className = 'msg ' + cls;
  d.textContent = text;
  log.appendChild(d);
  log.scrollTop = log.scrollHeight;
  return d;
}

function getOrCreateAssistantBubble() {
  const last = log.lastElementChild;
  if (last && last.dataset.streaming === 'true') return last;
  const d = addBubble('msg-assistant', '');
  d.dataset.streaming = 'true';
  return d;
}

function finalizeAssistantBubble() {
  const last = log.lastElementChild;
  if (last && last.dataset.streaming === 'true') {
    delete last.dataset.streaming;
    if (!last.textContent.trim()) last.remove();
  }
}

// ── Tree rendering ────────────────────────────────────────────

function renderTree(container, nodes) {
  container.innerHTML = '';
  nodes.forEach(n => container.appendChild(renderNode(n)));
}

function renderNode(node) {
  const wrap = document.createElement('div');

  const row = document.createElement('div');
  row.className = 'tree-node';

  const check = document.createElement('div');
  check.className = 'node-check' + (node.selected ? ' selected' : '');
  check.textContent = node.selected ? '✓' : '';

  const label = document.createElement('span');
  label.textContent = `${node.emoji} ${node.label}`;

  row.appendChild(check);
  row.appendChild(label);
  row.onclick = (e) => { e.stopPropagation(); node.selected = !node.selected; refreshTrees(); };
  wrap.appendChild(row);

  if (node.children && node.children.length) {
    const kids = document.createElement('div');
    kids.className = 'tree-children';
    node.children.forEach(c => kids.appendChild(renderNode(c)));
    wrap.appendChild(kids);
  }
  return wrap;
}

function refreshTrees() {
  if (currentPeopleTree) renderTree($('people-tree'), currentPeopleTree);
  if (currentPlaceTree) renderTree($('place-tree'), currentPlaceTree);
}

// ── SSE stream reader ─────────────────────────────────────────

async function readSSE(url, body, handlers) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed.startsWith('data: ')) continue;
      try {
        const data = JSON.parse(trimmed.slice(6));
        handlers(data);
      } catch(e) { console.warn('parse error', e); }
    }
  }
}

// ── Send message (TreeAgent) ──────────────────────────────────

async function sendMsg() {
  const input = $('msg-input');
  const text = input.value.trim();
  if (!text || sending) return;

  input.value = '';
  addBubble('msg-user', text);
  sending = true;
  $('btn-send').disabled = true;

  await readSSE(`${API}/chat`, { session_id: SESSION, message: text, user_name: 'tester' }, (data) => {
    switch (data.type) {
      case 'text': {
        const b = getOrCreateAssistantBubble();
        b.textContent += data.content;
        log.scrollTop = log.scrollHeight;
        break;
      }
      case 'people_tree':
        currentPeopleTree = data.nodes;
        renderTree($('people-tree'), data.nodes);
        $('btn-submit-tree').style.display = 'block';
        addBubble('msg-system', '↑ People tree updated in sidebar');
        break;
      case 'place_tree':
        currentPlaceTree = data.nodes;
        renderTree($('place-tree'), data.nodes);
        $('btn-submit-tree').style.display = 'block';
        addBubble('msg-system', '↑ Place tree updated in sidebar');
        break;
      case 'error':
        addBubble('msg-error', `Error: ${data.message}`);
        break;
    }
  });

  finalizeAssistantBubble();
  sending = false;
  $('btn-send').disabled = false;
  input.focus();
}

// ── Submit trees → FormAgent ──────────────────────────────────

async function submitTree() {
  if (!currentPeopleTree && !currentPlaceTree) return;

  phase = 'form';
  $('phase-text').textContent = 'Phase 2 — Generating form...';
  $('phase-bar').querySelector('.dot').className = 'dot dot-form';
  $('btn-submit-tree').style.display = 'none';
  addBubble('msg-system', 'Trees submitted. Generating form...');

  await readSSE(`${API}/submit-tree`, {
    session_id: SESSION,
    people_tree: currentPeopleTree || [],
    place_tree: currentPlaceTree || [],
  }, (data) => {
    switch (data.type) {
      case 'text': {
        const b = getOrCreateAssistantBubble();
        b.textContent += data.content;
        log.scrollTop = log.scrollHeight;
        break;
      }
      case 'text_form':
        renderForm(data);
        addBubble('msg-system', '↑ Form generated in sidebar');
        break;
      case 'error':
        addBubble('msg-error', `Error: ${data.message}`);
        break;
    }
  });

  finalizeAssistantBubble();
}

function renderForm(form) {
  const container = $('form-fields');
  container.innerHTML = '';
  const fields = [
    form.address,
    form.budget,
    form.date,
    form.duration,
    form.numberOfAttendees,
  ];
  fields.forEach(f => {
    const div = document.createElement('div');
    div.className = 'form-field';
    const lbl = document.createElement('label');
    lbl.textContent = f.label;
    const inp = document.createElement('input');
    inp.value = f.content || '';
    inp.dataset.label = f.label;
    div.appendChild(lbl);
    div.appendChild(inp);
    container.appendChild(div);
  });
  $('form-section').style.display = 'block';
  $('btn-submit-form').style.display = 'block';
}

function renderList(items) {
  const container = $('list-items');
  const list = (items || []).map(i => `• ${i}`).join('\n');
  container.textContent = list || 'No items suggested';
  $('list-section').style.display = 'block';
}

function renderSponsors(offers) {
  const container = $('sponsor-items');
  container.innerHTML = '';
  const list = offers || [];
  if (!list.length) {
    container.innerHTML = '<span style="color:#555">No sponsor calls yet</span>';
    return;
  }
  list.forEach(offer => {
    const div = document.createElement('div');
    const status = (offer.status || 'pending').toLowerCase();
    div.className = `sponsor-item ${status}`;
    const name = document.createElement('div');
    name.className = 'name';
    const discount = offer.discountPercent ? ` (${offer.discountPercent}% off)` : '';
    name.textContent = `${offer.retailer || 'Retailer'}${discount}`;
    const meta = document.createElement('div');
    meta.className = 'meta';
    const reason = offer.reason ? `${offer.reason}\n` : '';
    const items = (offer.discountedItems || []).map(i => `- ${i.item}: ${i.percent}%`).join('\n');
    meta.textContent = `${reason}${items}`.trim() || 'No details provided';
    div.appendChild(name);
    div.appendChild(meta);
    container.appendChild(div);
  });
}

function addSponsorPending(entry) {
  const container = $('sponsor-items');
  if (container.textContent.includes('No sponsor calls yet')) {
    container.innerHTML = '';
  }
  const div = document.createElement('div');
  div.className = 'sponsor-item pending';
  const name = document.createElement('div');
  name.className = 'name';
  name.textContent = entry.retailer || 'Retailer';
  const meta = document.createElement('div');
  meta.className = 'meta';
  meta.textContent = entry.reason || 'Checking sponsorship options...';
  div.appendChild(name);
  div.appendChild(meta);
  container.appendChild(div);
}

function renderCart(cart) {
  const container = $('cart-items');
  container.innerHTML = '';
  const items = cart.items || [];
  if (!items.length) {
    container.innerHTML = '<span style="color:#555">No items in cart</span>';
    $('cart-total').textContent = '';
    $('cart-section').style.display = 'block';
    return;
  }
  const pick = (entry, key) =>
    entry?.[key] ||
    entry?.[key.replace(/[A-Z]/g, m => `_${m.toLowerCase()}`)];
  const formatLine = (label, entry) => {
    if (!entry) return `${label}: n/a`;
    const price = typeof entry.price === 'number' ? entry.price.toFixed(2) : entry.price;
    const deliveryMs = entry.deliveryTimeMs || 0;
    const deliveryDays = Math.max(0, Math.round(deliveryMs / (24 * 60 * 60 * 1000)));
    return `${label}: €${price} · ${entry.retailer} · ${deliveryDays}d`;
  };
  items.forEach(entry => {
    const recommended =
      pick(entry, 'recommendedItem') || entry;
    const cheapest =
      pick(entry, 'cheapestItem') || entry;
    const bestRating =
      pick(entry, 'bestRatingItem') || entry;
    const fastest =
      pick(entry, 'fastestDeliveryItem') || entry;

    const div = document.createElement('div');
    div.className = 'cart-item';
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = recommended?.name || 'Item';
    const meta = document.createElement('div');
    meta.className = 'meta';
    const qty = recommended?.amount ?? 0;
    const recLine = formatLine('Rec', recommended);
    const cheapestLine = formatLine('Cheap', cheapest);
    const bestLine = formatLine('Best', bestRating);
    const fastLine = formatLine('Fast', fastest);
    meta.textContent = `Qty: ${qty} · ${recLine} | ${cheapestLine} | ${bestLine} | ${fastLine}`;
    div.appendChild(name);
    div.appendChild(meta);
    container.appendChild(div);
  });
  $('cart-total').textContent = `Total: €${(cart.price || 0).toFixed(2)}`;
  $('cart-section').style.display = 'block';
}

// ── Submit form ───────────────────────────────────────────────

async function submitForm() {
  const inputs = $('form-fields').querySelectorAll('input');
  const values = Array.from(inputs).map(inp => ({
    label: inp.dataset.label,
    content: inp.value,
  }));
  const map = Object.fromEntries(values.map(v => [v.label, v]));

  $('btn-submit-form').style.display = 'none';
  $('list-section').style.display = 'none';
  $('cart-section').style.display = 'none';
  $('sponsor-items').innerHTML = '<span style="color:#555">No sponsor calls yet</span>';

  addBubble('msg-system', 'Form submitted. Building cart...');

  await readSSE(`${API}/submit-form`, {
    session_id: SESSION,
    address: map['Address'] || { label: 'Address', content: '' },
    budget: map['Budget'] || { label: 'Budget', content: '' },
    date: map['Date'] || { label: 'Date', content: '' },
    duration: map['Duration (hours)'] || { label: 'Duration (hours)', content: '' },
    numberOfAttendees: map['Number of attendees'] || { label: 'Number of attendees', content: '' },
  }, (data) => {
    switch (data.type) {
      case 'text': {
        const b = getOrCreateAssistantBubble();
        b.textContent += data.content;
        log.scrollTop = log.scrollHeight;
        break;
      }
      case 'items':
        renderList(data.items || []);
        addBubble('msg-system', '↑ Suggested items from inventory');
        break;
      case 'tool': {
        addBubble('msg-system', `Tool: ${data.name} → ${JSON.stringify(data.arguments || {})}`);
        if (data.name === 'check_retailer_sponsorship') {
          const retailer = data.arguments?.retailer || 'Retailer';
          addSponsorPending({
            retailer,
            reason: data.reason || 'Checking sponsorship options...',
          });
        }
        break;
      }
      case 'tool_result': {
        addBubble('msg-system', `Tool result: ${data.name} → ${data.result}`);
        break;
      }
      case 'cart':
        renderCart(data);
        phase = 'done';
        $('phase-text').textContent = 'Phase 3 — Done!';
        $('phase-bar').querySelector('.dot').className = 'dot dot-done';
        addBubble('msg-system', '↑ Cart ready in sidebar');
        break;
      case 'retailer_offers':
        renderSponsors(data.offers || []);
        addBubble('msg-system', '↑ Retailer sponsorship results updated');
        break;
      case 'error':
        addBubble('msg-error', `Error: ${data.message}`);
        break;
    }
  });

  finalizeAssistantBubble();
}
</script>
</body>
</html>
