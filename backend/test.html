<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Agent Test</title>
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: system-ui, sans-serif; background: #0f0f0f; color: #e0e0e0; display: flex; height: 100vh; }

/* â”€â”€ Layout â”€â”€ */
#sidebar { width: 340px; border-right: 1px solid #2a2a2a; display: flex; flex-direction: column; overflow-y: auto; padding: 16px; gap: 16px; }
#main { flex: 1; display: flex; flex-direction: column; }
#chat-log { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
#input-bar { display: flex; gap: 8px; padding: 12px 16px; border-top: 1px solid #2a2a2a; }
#input-bar input { flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; font-size: 14px; }
#input-bar button { padding: 10px 20px; border-radius: 8px; border: none; background: #3b82f6; color: #fff; font-weight: 600; cursor: pointer; }
#input-bar button:disabled { opacity: .4; cursor: default; }
#btn-voice { position: relative; padding: 10px; width: 48px; background: #4ade80; }
#btn-voice.listening { background: #ef4444; animation: pulse 1.5s infinite; }
#btn-voice.processing { background: #f59e0b; }
#btn-voice.speaking { background: #8b5cf6; animation: pulse 1.5s infinite; }
@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
.voice-status { font-size: 11px; color: #888; margin-top: 4px; text-align: center; }

/* â”€â”€ Phase indicator â”€â”€ */
#phase-bar { padding: 10px 16px; background: #1a1a1a; border-bottom: 1px solid #2a2a2a; font-size: 13px; color: #888; display: flex; align-items: center; gap: 12px; }
#phase-bar .dot { width: 8px; height: 8px; border-radius: 50%; }
.dot-tree { background: #3b82f6; }
.dot-form { background: #f59e0b; }
.dot-done { background: #22c55e; }

/* â”€â”€ Chat bubbles â”€â”€ */
.msg { padding: 10px 14px; border-radius: 10px; max-width: 80%; white-space: pre-wrap; font-size: 14px; line-height: 1.5; }
.msg-user { background: #3b82f6; align-self: flex-end; }
.msg-assistant { background: #1e1e1e; border: 1px solid #2a2a2a; align-self: flex-start; }
.msg-error { background: #7f1d1d; align-self: flex-start; }
.msg-system { background: transparent; color: #666; font-size: 12px; align-self: center; font-style: italic; }

/* â”€â”€ Trees â”€â”€ */
.tree-section h3 { font-size: 13px; color: #888; margin-bottom: 6px; text-transform: uppercase; letter-spacing: .5px; }
.tree-node { display: flex; align-items: center; gap: 6px; padding: 4px 0; cursor: pointer; user-select: none; font-size: 14px; }
.tree-node:hover { color: #fff; }
.tree-children { margin-left: 20px; }
.node-check { width: 16px; height: 16px; border-radius: 4px; border: 2px solid #555; display: flex; align-items: center; justify-content: center; font-size: 10px; flex-shrink: 0; }
.node-check.selected { background: #3b82f6; border-color: #3b82f6; }

/* â”€â”€ Form â”€â”€ */
#form-section { display: none; }
#form-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
.form-field { margin-bottom: 10px; }
.form-field label { display: block; font-size: 12px; color: #888; margin-bottom: 3px; }
.form-field input { width: 100%; padding: 8px 10px; border-radius: 6px; border: 1px solid #333; background: #1a1a1a; color: #e0e0e0; font-size: 13px; }

/* â”€â”€ Lists / Cart â”€â”€ */
#list-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
#list-items { font-size: 12px; color: #bdbdbd; white-space: pre-wrap; }

#sponsor-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
.sponsor-item { padding: 8px 10px; border: 1px solid #2a2a2a; border-radius: 8px; margin-bottom: 8px; background: #151515; transition: opacity .4s ease, transform .4s ease; transition: opacity .4s ease, transform .4s ease; }
.sponsor-item.pending { border-left: 4px solid #f59e0b; }
.sponsor-item.approved { border-left: 4px solid #22c55e; }
.sponsor-item.rejected { border-left: 4px solid #ef4444; }
.sponsor-item .name { font-size: 13px; color: #e0e0e0; margin-bottom: 4px; }
.sponsor-item .meta { font-size: 12px; color: #999; white-space: pre-wrap; }
.sponsor-item.entering { opacity: 0; transform: translateY(8px); }
.sponsor-item.visible { opacity: 1; transform: translateY(0); }
.sponsor-waiting { display: flex; align-items: center; gap: 8px; padding: 8px 10px; color: #888; font-size: 12px; }
.sponsor-waiting .spinner { width: 14px; height: 14px; border: 2px solid #333; border-top-color: #f59e0b; border-radius: 50%; animation: spin .8s linear infinite; }
@keyframes spin { to { transform: rotate(360deg); } }

/* â”€â”€ In-chat sponsorship cards â”€â”€ */
.msg-sponsor { align-self: flex-start; max-width: 80%; padding: 0; background: transparent; border: none; }
.msg-sponsor .sponsor-card { padding: 10px 14px; border-radius: 10px; border: 1px solid #2a2a2a; background: #151515; }
.msg-sponsor .sponsor-card.approved { border-left: 4px solid #22c55e; }
.msg-sponsor .sponsor-card.rejected { border-left: 4px solid #ef4444; }
.msg-sponsor .sponsor-card .sc-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.msg-sponsor .sponsor-card .sc-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; flex-shrink: 0; }
.msg-sponsor .sponsor-card.approved .sc-icon { background: #22c55e; }
.msg-sponsor .sponsor-card.rejected .sc-icon { background: #ef4444; }
.msg-sponsor .sponsor-card .sc-retailer { font-size: 13px; font-weight: 600; color: #e0e0e0; }
.msg-sponsor .sponsor-card .sc-discount { font-size: 12px; color: #22c55e; margin-left: auto; }
.msg-sponsor .sponsor-card .sc-reason { font-size: 12px; color: #999; margin-bottom: 4px; }
.msg-sponsor .sponsor-card .sc-items { font-size: 11px; color: #777; }
.msg-sponsor .sponsor-card .sc-items span { display: block; }

.msg-sponsor-calling { align-self: flex-start; max-width: 80%; padding: 10px 14px; border-radius: 10px; background: #1a1a1a; border: 1px dashed #333; font-size: 13px; color: #888; display: flex; align-items: center; gap: 10px; }
.msg-sponsor-calling .spinner { width: 14px; height: 14px; border: 2px solid #333; border-top-color: #f59e0b; border-radius: 50%; animation: spin .8s linear infinite; flex-shrink: 0; }

/* â”€â”€ In-chat sponsorship cards â”€â”€ */
.msg-sponsor { align-self: flex-start; max-width: 80%; padding: 0; background: transparent; border: none; }
.msg-sponsor .sponsor-card { padding: 10px 14px; border-radius: 10px; border: 1px solid #2a2a2a; background: #151515; }
.msg-sponsor .sponsor-card.approved { border-left: 4px solid #22c55e; }
.msg-sponsor .sponsor-card.rejected { border-left: 4px solid #ef4444; }
.msg-sponsor .sponsor-card .sc-header { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
.msg-sponsor .sponsor-card .sc-icon { width: 20px; height: 20px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #fff; flex-shrink: 0; }
.msg-sponsor .sponsor-card.approved .sc-icon { background: #22c55e; }
.msg-sponsor .sponsor-card.rejected .sc-icon { background: #ef4444; }
.msg-sponsor .sponsor-card .sc-retailer { font-size: 13px; font-weight: 600; color: #e0e0e0; }
.msg-sponsor .sponsor-card .sc-discount { font-size: 12px; color: #22c55e; margin-left: auto; }
.msg-sponsor .sponsor-card .sc-reason { font-size: 12px; color: #999; margin-bottom: 4px; }
.msg-sponsor .sponsor-card .sc-items { font-size: 11px; color: #777; }
.msg-sponsor .sponsor-card .sc-items span { display: block; }

.msg-sponsor-calling { align-self: flex-start; max-width: 80%; padding: 10px 14px; border-radius: 10px; background: #1a1a1a; border: 1px dashed #333; font-size: 13px; color: #888; display: flex; align-items: center; gap: 10px; }
.msg-sponsor-calling .spinner { width: 14px; height: 14px; border: 2px solid #333; border-top-color: #f59e0b; border-radius: 50%; animation: spn .8s linear infinite; flex-shrink: 0; }
@keyframes spn { to { transform: rotate(360deg); } }

#cart-section { display: none; }
#cart-section h3 { font-size: 13px; color: #888; margin-bottom: 8px; text-transform: uppercase; letter-spacing: .5px; }
.cart-item { padding: 8px 10px; border: 1px solid #2a2a2a; border-radius: 8px; margin-bottom: 8px; background: #151515; }
.cart-item .name { font-size: 13px; color: #e0e0e0; margin-bottom: 4px; }
.cart-item .meta { font-size: 12px; color: #999; }
.cart-total { margin-top: 8px; font-size: 13px; color: #cbd5f5; }


/* â”€â”€ Sidebar controls â”€â”€ */

/* â”€â”€ Buttons â”€â”€ */
.btn-action { width: 100%; padding: 10px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; font-size: 14px; }
#btn-submit-tree { background: #f59e0b; color: #000; display: none; }
#btn-submit-form { background: #22c55e; color: #000; display: none; }
.btn-action:hover { filter: brightness(1.1); }
</style>
</head>
<body>

<div id="sidebar">
  <div class="tree-section">
    <h3>People Tree</h3>
    <div id="people-tree"><span style="color:#555">No tree yet</span></div>
  </div>
  <div class="tree-section">
    <h3>Place Tree</h3>
    <div id="place-tree"><span style="color:#555">No tree yet</span></div>
  </div>
  <button id="btn-submit-tree" class="btn-action" onclick="submitTree()">Submit Trees â†’</button>

  <div id="form-section">
    <h3>Form</h3>
    <div id="form-fields"></div>
    <button id="btn-submit-form" class="btn-action" onclick="submitForm()">Submit Form âœ“</button>
  </div>

  <div id="list-section">
    <h3>Shopping List</h3>
    <div id="list-items"><span style="color:#555">No list yet</span></div>
  </div>

  <div id="sponsor-section">
    <h3>Retailer Sponsorship</h3>
    <div id="sponsor-items"><span style="color:#555">No sponsor calls yet</span></div>
  </div>

  <div id="cart-section">
    <h3>Cart</h3>
    <div id="cart-items"><span style="color:#555">No cart yet</span></div>
    <div id="cart-total" class="cart-total"></div>
  </div>

</div>

<div id="main">
  <div id="phase-bar">
    <div class="dot dot-tree"></div>
    <span id="phase-text">Phase 1 â€” Chat with TreeAgent</span>
  </div>
  <div id="chat-log"></div>
  <div id="input-bar">
    <input id="msg-input" placeholder="Describe your event..." onkeydown="if(event.key==='Enter')sendMsg()">
    <button id="btn-voice" onclick="toggleVoice()" title="Voice mode">ðŸŽ¤</button>
    <button id="btn-send" onclick="sendMsg()">Send</button>
  </div>
  <div id="voice-status" class="voice-status" style="display:none;"></div>
</div>

<!-- Hidden audio player for TTS -->
<audio id="tts-audio" style="display:none;"></audio>
</div>

<script>
const API = 'http://localhost:8000';
const SESSION = crypto.randomUUID().slice(0, 8);

let currentPeopleTree = null;
let currentPlaceTree = null;
let phase = 'tree'; // tree | form | done
let sending = false;

// Voice mode state
let voiceMode = false;
let voiceState = 'idle'; // idle | listening | processing | speaking
let mediaRecorder = null;
let audioChunks = [];
let mediaStream = null; // Keep stream alive

const $ = id => document.getElementById(id);
const log = $('chat-log');

// â”€â”€ Chat helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function addBubble(cls, text) {
  const d = document.createElement('div');
  d.className = 'msg ' + cls;
  d.textContent = text;
  log.appendChild(d);
  log.scrollTop = log.scrollHeight;
  return d;
}

function getOrCreateAssistantBubble() {
  const last = log.lastElementChild;
  if (last && last.dataset.streaming === 'true') return last;
  const d = addBubble('msg-assistant', '');
  d.dataset.streaming = 'true';
  return d;
}

function finalizeAssistantBubble() {
  const last = log.lastElementChild;
  if (last && last.dataset.streaming === 'true') {
    delete last.dataset.streaming;
    if (!last.textContent.trim()) last.remove();
  }
}

// â”€â”€ Tree rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderTree(container, nodes) {
  container.innerHTML = '';
  nodes.forEach(n => container.appendChild(renderNode(n)));
}

function renderNode(node) {
  const wrap = document.createElement('div');

  const row = document.createElement('div');
  row.className = 'tree-node';

  const check = document.createElement('div');
  check.className = 'node-check' + (node.selected ? ' selected' : '');
  check.textContent = node.selected ? 'âœ“' : '';

  const label = document.createElement('span');
  label.textContent = `${node.emoji} ${node.label}`;

  row.appendChild(check);
  row.appendChild(label);
  row.onclick = (e) => { e.stopPropagation(); node.selected = !node.selected; refreshTrees(); };
  wrap.appendChild(row);

  if (node.children && node.children.length) {
    const kids = document.createElement('div');
    kids.className = 'tree-children';
    node.children.forEach(c => kids.appendChild(renderNode(c)));
    wrap.appendChild(kids);
  }
  return wrap;
}

function refreshTrees() {
  if (currentPeopleTree) renderTree($('people-tree'), currentPeopleTree);
  if (currentPlaceTree) renderTree($('place-tree'), currentPlaceTree);
}

// â”€â”€ SSE stream reader â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function readSSE(url, body, handlers) {
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(body),
  });
  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let buffer = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    buffer += decoder.decode(value, { stream: true });
    const lines = buffer.split('\n');
    buffer = lines.pop();
    for (const line of lines) {
      const trimmed = line.trim();
      if (!trimmed.startsWith('data: ')) continue;
      try {
        const data = JSON.parse(trimmed.slice(6));
        handlers(data);
      } catch(e) { console.warn('parse error', e); }
    }
  }
}

// â”€â”€ Send message (TreeAgent) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function sendMsg() {
  const input = $('msg-input');
  const text = input.value.trim();
  if (!text || sending) return;

  input.value = '';
  addBubble('msg-user', text);
  sending = true;
  $('btn-send').disabled = true;

  await readSSE(`${API}/chat`, { session_id: SESSION, message: text, user_name: 'tester' }, (data) => {
    switch (data.type) {
      case 'text': {
        const b = getOrCreateAssistantBubble();
        b.textContent += data.content;
        log.scrollTop = log.scrollHeight;
        break;
      }
      case 'people_tree':
        currentPeopleTree = data.nodes;
        renderTree($('people-tree'), data.nodes);
        $('btn-submit-tree').style.display = 'block';
        addBubble('msg-system', 'â†‘ People tree updated in sidebar');
        break;
      case 'place_tree':
        currentPlaceTree = data.nodes;
        renderTree($('place-tree'), data.nodes);
        $('btn-submit-tree').style.display = 'block';
        addBubble('msg-system', 'â†‘ Place tree updated in sidebar');
        break;
      case 'error':
        addBubble('msg-error', `Error: ${data.message}`);
        break;
    }
  });

  finalizeAssistantBubble();
  sending = false;
  $('btn-send').disabled = false;
  input.focus();
}

// â”€â”€ Submit trees â†’ FormAgent â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function submitTree() {
  if (!currentPeopleTree && !currentPlaceTree) return;

  phase = 'form';
  $('phase-text').textContent = 'Phase 2 â€” Generating form...';
  $('phase-bar').querySelector('.dot').className = 'dot dot-form';
  $('btn-submit-tree').style.display = 'none';
  addBubble('msg-system', 'Trees submitted. Generating form...');

  await readSSE(`${API}/submit-tree`, {
    session_id: SESSION,
    people_tree: currentPeopleTree || [],
    place_tree: currentPlaceTree || [],
  }, (data) => {
    switch (data.type) {
      case 'text': {
        const b = getOrCreateAssistantBubble();
        b.textContent += data.content;
        log.scrollTop = log.scrollHeight;
        break;
      }
      case 'text_form':
        renderForm(data);
        addBubble('msg-system', 'â†‘ Form generated in sidebar');
        break;
      case 'error':
        addBubble('msg-error', `Error: ${data.message}`);
        break;
    }
  });

  finalizeAssistantBubble();
}

function renderForm(form) {
  const container = $('form-fields');
  container.innerHTML = '';
  const fields = [
    form.address,
    form.budget,
    form.date,
    form.duration,
    form.numberOfAttendees,
  ];
  fields.forEach(f => {
    const div = document.createElement('div');
    div.className = 'form-field';
    const lbl = document.createElement('label');
    lbl.textContent = f.label;
    const inp = document.createElement('input');
    inp.value = f.content || '';
    inp.dataset.label = f.label;
    div.appendChild(lbl);
    div.appendChild(inp);
    container.appendChild(div);
  });
  $('form-section').style.display = 'block';
  $('btn-submit-form').style.display = 'block';
}

function renderList(items) {
  const container = $('list-items');
  const list = (items || []).map(i => `â€¢ ${i}`).join('\n');
  container.textContent = list || 'No items suggested';
  $('list-section').style.display = 'block';
}

let sponsorCount = 0;
let callingBubble = null;

function resetSponsors() {
  sponsorCount = 0;
  callingBubble = null;
  $('sponsor-items').innerHTML = '<span style="color:#555">Waiting for sponsorship calls...</span>';
}

function appendSponsorToSidebar(offer) {
  const container = $('sponsor-items');
  // Clear placeholder text on first real offer
  if (sponsorCount === 0) container.innerHTML = '';
  sponsorCount++;

  const div = document.createElement('div');
  const status = (offer.status || 'pending').toLowerCase();
  div.className = `sponsor-item ${status}`;
  const name = document.createElement('div');
  name.className = 'name';
  const discount = offer.discountPercent ? ` (${offer.discountPercent}% off)` : '';
  name.textContent = `${offer.retailer || 'Retailer'}${discount}`;
  const meta = document.createElement('div');
  meta.className = 'meta';
  const reason = offer.reason ? `${offer.reason}\n` : '';
  const items = (offer.discountedItems || []).map(i => `- ${i.item}: ${i.percent}%`).join('\n');
  meta.textContent = `${reason}${items}`.trim() || 'No details provided';
  div.appendChild(name);
  div.appendChild(meta);
  container.appendChild(div);
}

function finishSponsors() {
  if (sponsorCount === 0) {
    $('sponsor-items').innerHTML = '<span style="color:#555">No sponsorship offers received</span>';
  }
}

// â”€â”€ In-chat sponsorship cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function showCallingBubble(retailerName, itemCount) {
  removeCallingBubble();
  const d = document.createElement('div');
  d.className = 'msg msg-sponsor-calling';
  const suffix = itemCount ? ` (${itemCount} item${itemCount > 1 ? 's' : ''})` : '';
  d.innerHTML = `<div class="spinner"></div>Calling <strong>${retailerName}</strong> for sponsorship${suffix}...`;
  log.appendChild(d);
  log.scrollTop = log.scrollHeight;
  callingBubble = d;
}

function removeCallingBubble() {
  if (callingBubble) {
    callingBubble.remove();
    callingBubble = null;
  }
}

function addSponsorChatCard(offer) {
  removeCallingBubble();
  const status = (offer.status || 'rejected').toLowerCase();
  const icon = status === 'approved' ? '&#10003;' : '&#10007;';
  const discount = offer.discountPercent ? `${offer.discountPercent}% off` : '';
  const reason = offer.reason || '';
  const discountedItems = (offer.discountedItems || [])
    .filter(i => i.percent > 0)
    .map(i => `<span>&nbsp;&nbsp;${i.item}: ${i.percent}% off</span>`)
    .join('');

  const d = document.createElement('div');
  d.className = 'msg msg-sponsor';
  d.innerHTML = `
    <div class="sponsor-card ${status}">
      <div class="sc-header">
        <div class="sc-icon">${icon}</div>
        <div class="sc-retailer">${offer.retailer || 'Retailer'}</div>
        ${discount ? `<div class="sc-discount">${discount}</div>` : ''}
      </div>
      ${reason ? `<div class="sc-reason">${reason}</div>` : ''}
      ${discountedItems ? `<div class="sc-items">${discountedItems}</div>` : ''}
    </div>`;
  log.appendChild(d);
  log.scrollTop = log.scrollHeight;
}

function renderCart(cart) {
  const container = $('cart-items');
  container.innerHTML = '';
  const items = cart.items || [];
  if (!items.length) {
    container.innerHTML = '<span style="color:#555">No items in cart</span>';
    $('cart-total').textContent = '';
    $('cart-section').style.display = 'block';
    return;
  }
  const pick = (entry, key) =>
    entry?.[key] ||
    entry?.[key.replace(/[A-Z]/g, m => `_${m.toLowerCase()}`)];
  const formatLine = (label, entry) => {
    if (!entry) return `${label}: n/a`;
    const price = typeof entry.price === 'number' ? entry.price.toFixed(2) : entry.price;
    const deliveryMs = entry.deliveryTimeMs || 0;
    const deliveryDays = Math.max(0, Math.round(deliveryMs / (24 * 60 * 60 * 1000)));
    return `${label}: â‚¬${price} Â· ${entry.retailer} Â· ${deliveryDays}d`;
  };
  items.forEach(entry => {
    const recommended =
      pick(entry, 'recommendedItem') || entry;
    const cheapest =
      pick(entry, 'cheapestItem') || entry;
    const bestRating =
      pick(entry, 'bestRatingItem') || entry;
    const fastest =
      pick(entry, 'fastestDeliveryItem') || entry;

    const div = document.createElement('div');
    div.className = 'cart-item';
    const name = document.createElement('div');
    name.className = 'name';
    name.textContent = recommended?.name || 'Item';
    const meta = document.createElement('div');
    meta.className = 'meta';
    const qty = recommended?.amount ?? 0;
    const recLine = formatLine('Rec', recommended);
    const cheapestLine = formatLine('Cheap', cheapest);
    const bestLine = formatLine('Best', bestRating);
    const fastLine = formatLine('Fast', fastest);
    meta.textContent = `Qty: ${qty} Â· ${recLine} | ${cheapestLine} | ${bestLine} | ${fastLine}`;
    div.appendChild(name);
    div.appendChild(meta);
    container.appendChild(div);
  });
  $('cart-total').textContent = `Total: â‚¬${(cart.price || 0).toFixed(2)}`;
  $('cart-section').style.display = 'block';
}

// â”€â”€ Submit form â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function submitForm() {
  const inputs = $('form-fields').querySelectorAll('input');
  const values = Array.from(inputs).map(inp => ({
    label: inp.dataset.label,
    content: inp.value,
  }));
  const map = Object.fromEntries(values.map(v => [v.label, v]));

  $('btn-submit-form').style.display = 'none';
  $('list-section').style.display = 'none';
  $('cart-section').style.display = 'none';
  resetSponsors();

  addBubble('msg-system', 'Form submitted. Building cart and contacting retailers...');

  await readSSE(`${API}/submit-form`, {
    session_id: SESSION,
    address: map['Address'] || { label: 'Address', content: '' },
    budget: map['Budget'] || { label: 'Budget', content: '' },
    date: map['Date'] || { label: 'Date', content: '' },
    duration: map['Duration (hours)'] || { label: 'Duration (hours)', content: '' },
    numberOfAttendees: map['Number of attendees'] || { label: 'Number of attendees', content: '' },
  }, (data) => {
    switch (data.type) {
      case 'text': {
        const b = getOrCreateAssistantBubble();
        b.textContent += data.content;
        log.scrollTop = log.scrollHeight;
        break;
      }
      case 'items':
        renderList(data.items || []);
        addBubble('msg-system', 'â†‘ Suggested items from inventory');
        break;
      case 'tool': {
        addBubble('msg-system', `Tool: ${data.name} â†’ ${JSON.stringify(data.arguments || {})}`);
        break;
      }
      case 'tool_result': {
        addBubble('msg-system', `Tool result: ${data.name} â†’ ${data.result}`);
        break;
      }
      case 'retailer_call_start': {
        // Show a loading spinner in the chat for this retailer
        showCallingBubble(data.retailer, data.itemCount || 0);
        break;
      }
      case 'retailer_offers': {
        // Result for one retailer â€” render card in chat + sidebar
        const offers = data.offers || [];
        offers.forEach(offer => {
          addSponsorChatCard(offer);
          appendSponsorToSidebar(offer);
        });
        break;
      }
      case 'cart':
        removeCallingBubble();
        finishSponsors();
        renderCart(data);
        phase = 'done';
        $('phase-text').textContent = 'Phase 3 â€” Done!';
        $('phase-bar').querySelector('.dot').className = 'dot dot-done';
        addBubble('msg-system', 'â†‘ Cart ready in sidebar');
        break;
      case 'error':
        addBubble('msg-error', `Error: ${data.message}`);
        break;
    }
  });

  finalizeAssistantBubble();
}

// â”€â”€ Voice mode â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

async function toggleVoice() {
  if (!voiceMode) {
    // Start voice mode
    voiceMode = true;
    $('btn-voice').classList.add('processing');
    updateVoiceStatus('Initializing voice mode...');
    
    try {
      // Request microphone permission once
      if (!mediaStream) {
        mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
      }
      
      // Start voice session
      const res = await fetch(`${API}/start-voice`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ session_id: SESSION, message: '', user_name: 'tester' }),
      });
      
      const data = await res.json();
      
      // Show voice status
      $('voice-status').style.display = 'block';
      
      // Play greeting
      await playTTSAudio(data.audio_id, data.text);
      
      // Start listening
      await startListening();
    } catch (err) {
      console.error('Voice mode error:', err);
      addBubble('msg-error', `Voice error: ${err.message}`);
      voiceMode = false;
      $('btn-voice').classList.remove('processing');
      updateVoiceStatus('');
      // Clean up stream on error
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
    }
  } else {
    // Stop voice mode
    stopListening();
    voiceMode = false;
    voiceState = 'idle';
    $('btn-voice').classList.remove('listening', 'processing', 'speaking');
    $('voice-status').style.display = 'none';
    updateVoiceStatus('');
    // Stop media stream
    if (mediaStream) {
      mediaStream.getTracks().forEach(track => track.stop());
      mediaStream = null;
    }
  }
}

let audioContext = null;
let analyserNode = null;
let silenceTimeout = null;
let vadCheckInterval = null;

async function startListening() {
  if (voiceState !== 'idle') return;
  
  try {
    // Use existing stream instead of requesting new permission
    if (!mediaStream) {
      mediaStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    }
    
    mediaRecorder = new MediaRecorder(mediaStream);
    audioChunks = [];
    
    // Setup audio context for VAD if not already done
    if (!audioContext) {
      audioContext = new (window.AudioContext || window.webkitAudioContext)();
    }
    
    const source = audioContext.createMediaStreamSource(mediaStream);
    analyserNode = audioContext.createAnalyser();
    analyserNode.fftSize = 512;
    analyserNode.smoothingTimeConstant = 0.8;
    source.connect(analyserNode);
    
    const bufferLength = analyserNode.frequencyBinCount;
    const dataArray = new Uint8Array(bufferLength);
    
    let speechDetected = false;
    let silenceStart = null;
    
    function checkVoiceActivity() {
      if (!mediaRecorder || mediaRecorder.state !== 'recording') {
        return;
      }
      
      analyserNode.getByteFrequencyData(dataArray);
      
      // Calculate average volume
      let sum = 0;
      for (let i = 0; i < bufferLength; i++) {
        sum += dataArray[i];
      }
      const average = sum / bufferLength;
      
      console.log('Audio level:', average);
      
      // Threshold for speech detection (adjust if needed)
      const SPEECH_THRESHOLD = 30;
      const SILENCE_DURATION = 1000; // 1 second of silence
      
      if (average > SPEECH_THRESHOLD) {
        // Speech detected
        if (!speechDetected) {
          console.log('Speech started');
          speechDetected = true;
          updateVoiceStatus('Listening... (speaking detected)');
        }
        silenceStart = null;
      } else if (speechDetected) {
        // Silence after speech
        if (!silenceStart) {
          silenceStart = Date.now();
          console.log('Silence started');
        } else {
          const silenceDuration = Date.now() - silenceStart;
          if (silenceDuration > SILENCE_DURATION) {
            console.log('Silence threshold reached, stopping recording');
            stopListening();
          }
        }
      }
    }
    
    mediaRecorder.ondataavailable = (event) => {
      if (event.data.size > 0) {
        audioChunks.push(event.data);
      }
    };
    
    mediaRecorder.onstop = async () => {
      const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
      
      // Cleanup VAD
      if (vadCheckInterval) {
        clearInterval(vadCheckInterval);
        vadCheckInterval = null;
      }
      
      await sendAudioToServer(audioBlob);
      audioChunks = [];
    };
    
    mediaRecorder.start();
    voiceState = 'listening';
    $('btn-voice').classList.remove('processing', 'speaking');
    $('btn-voice').classList.add('listening');
    updateVoiceStatus('Listening... (speak now)');
    
    // Start VAD checking
    vadCheckInterval = setInterval(checkVoiceActivity, 100);
    
    // Change button behavior to stop recording manually
    $('btn-voice').onclick = stopListening;
  } catch (err) {
    console.error('Microphone error:', err);
    addBubble('msg-error', `Microphone error: ${err.message}`);
    voiceMode = false;
    updateVoiceStatus('');
  }
}

function stopListening() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    console.log('Stopping recording');
    mediaRecorder.stop();
    voiceState = 'processing';
    $('btn-voice').classList.remove('listening');
    $('btn-voice').classList.add('processing');
    updateVoiceStatus('Processing...');
    
    // Cleanup VAD
    if (vadCheckInterval) {
      clearInterval(vadCheckInterval);
      vadCheckInterval = null;
    }
    
    // Restore button behavior
    $('btn-voice').onclick = toggleVoice;
  }
}

async function sendAudioToServer(audioBlob) {
  try {
    const formData = new FormData();
    formData.append('audio', audioBlob, 'voice-input.webm');
    formData.append('session_id', SESSION);
    
    const res = await fetch(`${API}/voice-input`, {
      method: 'POST',
      body: formData,
    });
    
    const data = await res.json();
    
    // Display what the user actually said (transcribed text)
    if (data.transcribed_text) {
      addBubble('msg-user', '[Voice] ' + data.transcribed_text);
    }
    
    // Play TTS response
    await playTTSAudio(data.audio_id, data.text);
    
    // Check if done or if we shouldn't wait for input
    if (data.phase === 'done' || data.phase === 'error') {
      voiceMode = false;
      voiceState = 'idle';
      $('btn-voice').classList.remove('listening', 'processing', 'speaking');
      $('voice-status').style.display = 'none';
      updateVoiceStatus('');
      addBubble('msg-system', 'Voice session ended.');
      // Stop media stream
      if (mediaStream) {
        mediaStream.getTracks().forEach(track => track.stop());
        mediaStream = null;
      }
    } else if (data.wait_for_input !== false) {
      // Only continue listening if wait_for_input is not explicitly false
      await startListening();
    } else {
      // Don't start listening - backend is processing
      voiceState = 'idle';
      $('btn-voice').classList.remove('listening', 'processing', 'speaking');
      updateVoiceStatus('Ready for next question...');
    }
  } catch (err) {
    console.error('Audio upload error:', err);
    addBubble('msg-error', `Upload error: ${err.message}`);
    voiceMode = false;
    voiceState = 'idle';
    $('btn-voice').classList.remove('listening', 'processing', 'speaking');
    updateVoiceStatus('');
    // Stop media stream on error
    if (mediaStream) {
      mediaStream.getTracks().forEach(track => track.stop());
      mediaStream = null;
    }
  }
}

async function playTTSAudio(audioId, text) {
  return new Promise((resolve, reject) => {
    const audio = $('tts-audio');
    const audioUrl = `${API}/tts-audio/${audioId}`;
    
    voiceState = 'speaking';
    $('btn-voice').classList.remove('listening', 'processing');
    $('btn-voice').classList.add('speaking');
    updateVoiceStatus('Speaking...');
    
    // Show assistant message
    addBubble('msg-assistant', text);
    
    audio.src = audioUrl;
    audio.onended = () => {
      voiceState = 'idle';
      $('btn-voice').classList.remove('speaking');
      resolve();
    };
    audio.onerror = (err) => {
      console.error('Audio playback error:', err);
      voiceState = 'idle';
      $('btn-voice').classList.remove('speaking');
      reject(err);
    };
    
    audio.play().catch(err => {
      console.error('Audio play error:', err);
      voiceState = 'idle';
      $('btn-voice').classList.remove('speaking');
      reject(err);
    });
  });
}

function updateVoiceStatus(message) {
  const statusEl = $('voice-status');
  if (message) {
    statusEl.textContent = message;
    statusEl.style.display = 'block';
  } else {
    statusEl.textContent = '';
    statusEl.style.display = 'none';
  }
}
</script>
</body>
</html>
